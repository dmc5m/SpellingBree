<html>
  <body>
    <div>
      <div id="currentWord"></div>
      <button id="nextWord">Next Word</button>
      <input type="text" id="answer" />
      <div id="feedback"></div>
    </div>
    <script>
window.onload = () => {
  const levels = {
    1: ["cat", "dog", "sun", "hat"],
    2: ["apple", "green", "chair", "cloud"],
    3: ["simple", "castle", "wonder", "puzzle"]
  };
  let currentLevel = 1;
  let currentWord = "";
  const rate = -15; // slower speech

  const API_BASE = "https://gratitude-web-app4-gsfxc4cpfugcggbt.westus-01.azurewebsites.net";
  const API_KEY = "YOUR_FIREBASE_API_KEY_HERE"; // replace with your real key

  async function speak(text) {
    const params = new URLSearchParams({ text, rate });
    const res = await fetch(`${API_BASE}/api/tts?${params.toString()}`, { method: "GET" });
    if (!res.ok) {
      console.error("TTS error:", await res.text());
      return;
    }
    const blob = await res.blob();
    const audio = new Audio(URL.createObjectURL(blob));
    audio.play();
  }

  async function getFeedback(misspelling, correct) {
    const payload = {
      userInput: `The student spelled "${misspelling}" instead of "${correct}".`,
      systemMessage: "You are a kind and encouraging third-grade teacher. Give short, spoken-style feedback about how close their spelling was and a gentle hint if helpful."
    };

    const res = await fetch(`${API_BASE}/api/take-stock`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-Key": API_KEY
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      console.error("GPT error:", await res.text());
      return "Hmm, something went wrong generating feedback.";
    }

    const data = await res.json();
    return data.coachReply || "Good try! Let's keep practicing.";
  }

  function pickWord() {
    const words = levels[currentLevel];
    currentWord = words[Math.floor(Math.random() * words.length)];
    document.getElementById("currentWord").textContent = currentWord;
    speak(`Please spell the word ${currentWord}.`);
  }

  document.getElementById("nextWord").onclick = pickWord;

  document.getElementById("answer").addEventListener("change", async e => {
    const answer = e.target.value.trim().toLowerCase();
    const feedbackEl = document.getElementById("feedback");

    if (answer === currentWord.toLowerCase()) {
      feedbackEl.textContent = "✅ Correct!";
      await speak(`Correct! ${currentWord} is spelled ${currentWord}.`);
    } else {
      feedbackEl.textContent = "⏳ Thinking...";
      const gptFeedback = await getFeedback(answer, currentWord);
      feedbackEl.textContent = gptFeedback;
      await speak(gptFeedback);
    }

    e.target.value = "";
  });
};
</script>
  </body>
</html>
