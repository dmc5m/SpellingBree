<html>
  <body>
    <div>
      <div id="currentWord"></div>
      <button id="nextWord">Skip</button>
      <input type="text" id="answer" />
      <div id="feedback"></div>
    </div>
    <script>
window.onload = () => {
  const levels = {
    1: ["cat", "dog", "sun", "hat"],
    2: ["apple", "green", "chair", "cloud"],
    3: ["simple", "castle", "wonder", "puzzle"]
  };
  let currentLevel = 1;
  let correctCount = 0;
  let attempts = 0;
  // Load saved progress
  const savedLevel = localStorage.getItem("level");
  const savedCorrect = localStorage.getItem("correctCount");
  if (savedLevel) currentLevel = parseInt(savedLevel);
  if (savedCorrect) correctCount = parseInt(savedCorrect);
  let currentWord = "";
  const rate = -15; // slower speech

  const API_BASE = "https://gratitude-web-app4-gsfxc4cpfugcggbt.westus-01.azurewebsites.net";

  async function speak(text) {
    const answerInput = document.getElementById("answer");
    answerInput.disabled = true;
    const params = new URLSearchParams({ text, rate });
    const res = await fetch(`${API_BASE}/api/tts?${params.toString()}`, { method: "GET" });
    if (!res.ok) {
      console.error("TTS error:", await res.text());
      answerInput.disabled = false;
      return;
    }
    const blob = await res.blob();
    const audio = new Audio(URL.createObjectURL(blob));
    return new Promise(resolve => {
      audio.onended = () => {
        answerInput.disabled = false;
        answerInput.focus();
        resolve();
      };
      audio.play();
    });
  }

  async function pickWord() {
    const words = levels[currentLevel];
    currentWord = words[Math.floor(Math.random() * words.length)];
    document.getElementById("currentWord").textContent = `Level ${currentLevel}`;
    document.getElementById("feedback").textContent = `⭐ ${correctCount} correct out of ${attempts}`;
    await speak(`Level ${currentLevel}. Please spell the word.`);
  }

  document.getElementById("nextWord").onclick = pickWord;

  document.getElementById("answer").addEventListener("change", async e => {
    attempts++;
    const answer = e.target.value.trim().toLowerCase();
    const feedbackEl = document.getElementById("feedback");

    if (answer === currentWord.toLowerCase()) {
      correctCount++;
      localStorage.setItem("correctCount", correctCount);
      localStorage.setItem("level", currentLevel);
      await speak(`Great job! You spelled the word correctly.`);
      if (correctCount % 5 === 0 && currentLevel < Object.keys(levels).length) {
        currentLevel++;
        localStorage.setItem("level", currentLevel);
        await speak(`Excellent! Moving on to level ${currentLevel}.`);
      }
      document.getElementById("feedback").textContent = `⭐ ${correctCount} correct out of ${attempts}`;
      e.target.value = "";
      await pickWord();
    } else {
      try {
        const payload = {
          misspelling: answer,
          correct: currentWord,
          rate
        };
        const res = await fetch(`${API_BASE}/api/speller-voice`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          console.error("Speller-voice error:", await res.text());
          return;
        }
        const blob = await res.blob();
        const audio = new Audio(URL.createObjectURL(blob));
        await new Promise(resolve => {
          audio.onended = resolve;
          audio.play();
        });
      } catch (err) {
        console.error("Error fetching speller-voice audio:", err);
      }
      document.getElementById("feedback").textContent = `⭐ ${correctCount} correct out of ${attempts}`;
      e.target.value = "";
      // retry same word, so do not change currentWord or pick new word
    }
  });
};
</script>
  </body>
</html>
