<html>
  <body>
    <div id="splash" style="display:flex; justify-content:center; align-items:center; height:100vh; font-size:3em; font-weight:bold;">
      Welcome to Spelling Bree
    </div>
    <div id="gameUI" style="display:none;">
      <div>
        <div id="currentWord"></div>
        <button id="nextWord">Skip</button>
        <button id="sayItAgain" style="display:inline-block;">Say It Again</button>
        <input type="text" id="answer" />
        <div id="feedback"></div>
      </div>
    </div>
    <script>
window.onload = () => {
  const levels = {
    1: ["cat", "dog", "sun", "hat"],
    2: ["apple", "green", "chair", "cloud"],
    3: ["simple", "castle", "wonder", "puzzle"]
  };
  let currentLevel = 1;
  let correctCount = 0;
  let attempts = 0;
  // Load saved progress
  const savedLevel = localStorage.getItem("level");
  const savedCorrect = localStorage.getItem("correctCount");
  if (savedLevel) currentLevel = parseInt(savedLevel);
  if (savedCorrect) correctCount = parseInt(savedCorrect);
  let currentWord = "";
  const rate = -15; // slower speech

  const API_BASE = "https://gratitude-web-app4-gsfxc4cpfugcggbt.westus-01.azurewebsites.net";

  async function speak(text) {
    const answerInput = document.getElementById("answer");
    answerInput.disabled = true;
    const params = new URLSearchParams({ text, rate });
    const res = await fetch(`${API_BASE}/api/tts?${params.toString()}`, { method: "GET" });
    if (!res.ok) {
      console.error("TTS error:", await res.text());
      answerInput.disabled = false;
      return;
    }
    const blob = await res.blob();
    const audio = new Audio(URL.createObjectURL(blob));
    audio.play();
    audio.onended = () => {
      answerInput.disabled = false;
      answerInput.focus();
    };
  }

  function pickWord() {
    const words = levels[currentLevel];
    currentWord = words[Math.floor(Math.random() * words.length)];
    document.getElementById("currentWord").textContent = `Level ${currentLevel}`;
    document.getElementById("feedback").textContent = `⭐ ${correctCount} correct out of ${attempts}`;
    speak(`Level ${currentLevel}. Please spell the word.`);
  }

  async function wakeApi() {
    try {
      await fetch("http://gratitude-web-app4-gsfxc4cpfugcggbt.westus-01.azurewebsites.net/health");
    } catch (e) {
      console.error("Error waking API:", e);
    }
  }

  document.getElementById("nextWord").onclick = pickWord;

  document.getElementById("sayItAgain").onclick = () => {
    if (currentWord) {
      speak(`Level ${currentLevel}. Please spell the word.`);
    }
  };

  document.getElementById("answer").addEventListener("change", async e => {
    attempts++;
    const answer = e.target.value.trim().toLowerCase();
    const feedbackEl = document.getElementById("feedback");

    if (answer === currentWord.toLowerCase()) {
      correctCount++;
      localStorage.setItem("correctCount", correctCount);
      localStorage.setItem("level", currentLevel);
      await speak(`Great job! You spelled the word correctly.`);
      if (correctCount % 5 === 0 && currentLevel < Object.keys(levels).length) {
        currentLevel++;
        localStorage.setItem("level", currentLevel);
        await speak(`Excellent! Moving on to level ${currentLevel}.`);
      }
      document.getElementById("feedback").textContent = `⭐ ${correctCount} correct out of ${attempts}`;
      pickWord();
      e.target.value = "";
    } else {
      try {
        const payload = {
          misspelling: answer,
          correct: currentWord,
          rate
        };
        const res = await fetch(`${API_BASE}/api/speller-voice`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          console.error("Speller-voice error:", await res.text());
          return;
        }
        const blob = await res.blob();
        const audio = new Audio(URL.createObjectURL(blob));
        audio.play();
      } catch (err) {
        console.error("Error fetching speller-voice audio:", err);
      }
      document.getElementById("feedback").textContent = `⭐ ${correctCount} correct out of ${attempts}`;
    }
  });

  // Show splash screen and wait for 3 seconds, then hide splash and show game UI, wake API, and start first word
  (async () => {
    await wakeApi();
    setTimeout(() => {
      document.getElementById("splash").style.display = "none";
      document.getElementById("gameUI").style.display = "block";
      pickWord();
    }, 3000);
  })();
};
</script>
  </body>
</html>
